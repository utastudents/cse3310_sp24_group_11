<!DOCTYPE html>


<html>
<head>
    <title>Word Search Game</title>
</head>
<body>
    <div id = "backToLobby" style = "display:none">
        <button onclick = "backToLobby()">Back to Lobby</button>
    </div>
    <div id="wordGridAndChat" style="display:none; justify-content: space-evenly;">
        <div id="wordGrid"></div>
        <div id="GlobalChat">
            <h1>Global Chat</h1>
            <div id="chatMessages" style="width: 300px; height: 200px; overflow: scroll;"></div>
            <input type="text" id="chatInput">
            <button onclick="saveAllChats()">Send</button>
        </div>
    </div>
    <div id = "getUsername">
        <h1>Enter your username</h1>
        <input type = "text" id = "username">
        <button onclick = "checkUsername()">Submit</button>
    </div> 
    <div id = "Lobby" style = "display:none">
        <h1>Word Search Game Lobby</h1>
        <table>
            <tr>
                <td><button onclick="fetchPlayersList(); 
                                     document.getElementById('Players').style.display = 'block';"
                                     >Show Players Online</button>
                <td><button onclick="fetchRooms();
                                     document.getElementById('AvailableRooms').style.display = 'block';"
                                     >Show Rooms</button>
                <td><button id="createRoom" onclick = "addRooms(); 
                                                       document.getElementById('AvailableRooms').style.display = 'block';"
                                                       >Create Room</button>
            </tr>
        </table>
    </div>
    <div id="AvailableRooms" style="display:none">
        <h1>Available Rooms</h1>
        <ul id="roomsList">
            <!-- Rooms will be added here dynamically -->
        </ul>
    </div>
    <div id="Players" style="display: none;">
        <h1>Online Players</h1>
        <ul id="playerList">
            <!-- Players will be added here dynamically -->
        </ul>
    </div>

    <div id="waitingforplayer" style="display:none">
        <h1>Waiting for another player to join</h1>
    </div>
<!--     <div id="wordSearchContainer">
        <table>
            <tbody id="wordSearchGrid">
            </tbody>
        </table>
    </div>
    <div id="chatContainer">
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
    </div> -->

    <script>
        var serverUrl;
        serverUrl = "ws://" + window.location.hostname +":"+ (parseInt(location.port) + 100);
        connection = new WebSocket(serverUrl);
        // idx = -1;
        // var gameid = -1;
        connection.onmessage = function(event) {
            var data = JSON.parse(event.data);
            switch (data.type) {
                case "UsernameError":
                    handleUsernameError(data);
                    break;
                case "UsernameSuccess":
                    handleUsernameSuccess(data);
                    break;
                case "roomList":
                    updateRoomList(data.rooms);
                    break;
                case "fetchPlayerList":
                    printPlayersList(data.players);
                    break;
                case "chatMessages":
                    printChat(data.messages);
                    break;
                case "wordGrid":
                    populateWordGrid(data.grid);
                    break;
                case "removePlayer":
                    removePlayer(data.removePlayerName);
                    break;
                default:
                    console.log("Unknown message", data);
            }
        };

        // Username functions

        function checkUsername(){
            var username = document.getElementById("username").value;
            if(username == ""){
                alert('Box cannot be left blank!');
                return; 
            }
            //length myust be less than 8
            if(username.length > 8){
                alert('Username must be less than 8 characters');
                return;
            }
            connection.send(JSON.stringify({name: username}));
        }
        function handleUsernameError(data) {
            alert(data.msg);
            document.getElementById("getUsername").style.display = "block";
            document.getElementById("Lobby").style.display = "none";
        }
        function handleUsernameSuccess() {
            document.getElementById("getUsername").style.display = "none";
            document.getElementById("Lobby").style.display = "table";
            fetchPlayersList();
        }

        // Player functions

        function fetchPlayersList() {
            connection.send(JSON.stringify({action: "fetchPlayersList"}));
        }
        function printPlayersList(players) {
            if(players){
                var playerListElement = document.getElementById("playerList");
                playerListElement.innerHTML = ""; // Clear existing list
                players.forEach(function(player) {
                    var listItem = document.createElement("li");
                    listItem.textContent = player;
                    playerListElement.appendChild(listItem);
                });
            }
        }


        // Room functions

        function addRooms() {
            var username = document.getElementById("username").value;
            connection.send(JSON.stringify({action: "addRoom", playerName: username}));
            fetchRooms();
        }
        function fetchRooms() {
            connection.send(JSON.stringify({action: "fetchRooms"}));
        }  
        function updateRoomList(data){
            if (Array.isArray(data)) {
                var roomsList = document.getElementById("roomsList");
                roomsList.innerHTML = "";
                data.forEach(function(playername) {
                    var listItem = document.createElement("li");
                    listItem.textContent = playername + "'s room";
                    var joinButton = document.createElement("button");
                    joinButton.textContent = "Join";
                    joinButton.onclick = function() {
                        connection.send(JSON.stringify({action: "joinRoom", playerName: playername}));
                        fetchChat();
                        startGame();
                    };
                    
                    var removeButton = document.createElement("button");
                    removeButton.textContent = "Remove";
                    removeButton.onclick = function() {
                        connection.send(JSON.stringify({action: "removeRoom", playerName: playername}));
                        listItem.remove();
                    };
                    listItem.appendChild(joinButton);
                    listItem.appendChild(removeButton);
                    roomsList.appendChild(listItem);
                });
            }
        };

        // Game/WordGrid functions

        function startGame(){
            document.getElementById("Lobby").style.display = "none";
            document.getElementById("waitingforplayer").style.display = "block";
            document.getElementById("AvailableRooms").style.display = "none";
            document.getElementById("Players").style.display = "none";
            document.getElementById("backToLobby").style.display = "Block";
            document.getElementById("wordGridAndChat").style.display = "flex";

            connection.send(JSON.stringify({action: "fetchGrid"}));
        }
        function populateWordGrid(data) {
            var wordGrid = data.wordsGrid;
            var gridHtml = "<table>";
            for(var i = 0; i < wordGrid.length; i++){
                gridHtml += "<tr>";
                for(var j = 0; j < wordGrid[i].length; j++){
                    gridHtml += `<td><button class="grid-button" onmousedown="changeCellColor(this, true)" onmouseover="changeCellColor(this)" onmouseup="changeCellColor(this, false)" style="border: 1px solid black; padding: 2px; text-align: center; cursor: pointer; font-size: 10px;">${wordGrid[i][j]}</button></td>`;
                }
                gridHtml += "</tr>";
            }
            gridHtml += "</table>";
            document.getElementById("waitingforplayer").style.display = "none";
            document.getElementById("wordGrid").innerHTML = gridHtml;
        }

        // Chat functions
        function fetchChat(){
            connection.send(JSON.stringify({action: "fetchChat"}));
        }
        function printChat(messages) {
            var chatMessages = document.getElementById("chatMessages");
            chatMessages.innerHTML = "";
            if (messages && Array.isArray(messages)) {
                messages.forEach(function(msg) {
                    chatMessages.innerHTML += msg + "<br/>";
                });
            }
            chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to the bottom
        }
        function saveAllChats(){
            var message = document.getElementById("chatInput").value;
            var username = document.getElementById("username").value;
            if (message != "") connection.send(JSON.stringify({action: "saveAllChats", message: username + ": " + message}));
            document.getElementById("chatInput").value = "";
        }

        // Cell functions

        var isMouseDown = false;
        var changedCells = [];
        function changeCellColor(cell, mouseDownUp = null) {
           var button = cell.querySelector("button"); // Gets the button
           if (mouseDownUp === true) {
               button.classList.add("selected");
               if (!changedCells.includes(button)) {
                   changedCells.push(button);
               }
           } else if (mouseDownUp === false) {
               button.classList.remove("selected"); // Remove the selected class from the button
           } else if (isMouseDown) {
               button.classList.add("selected"); // Add the selected class to the button
               // Add the button to changedCells array if not already included
               if (!changedCells.includes(button)) {
           changedCells.push(button);
               }
           }
        }
        function resetCellColors() {
            changedCells.forEach(function(cell) {
                cell.style.backgroundColor = ""; // Reset color
            });
            // Clear the array after resetting colors
            changedCells = [];
        }
        document.addEventListener('mouseup', function() {
            isMouseDown = false;
            resetCellColors(); // Reset colors on mouse up anywhere in the document
        });


        function backToLobby(){
            document.getElementById("wordGridAndChat").style.display = "none";
            document.getElementById("Lobby").style.display = "block";
            document.getElementById("backToLobby").style.display = "none";
            document.getElementById("waitingforplayer").style.display = "none";
        }
      </script>
</body>
</html>
