<!DOCTYPE html>


<html>
<head>
    <title>Word Search Game</title>
</head>
<body>
    <div id="wordGrid" style="display:none"></div>
    <div id = "getUsername">
        <h1>Enter your username</h1>
        <input type = "text" id = "username">
        <button onclick = "checkUsername()">Submit</button>
    </div> 
    <div id = "Game" style = "display:none">
        <h1>Game</h1>
        <button onclick = "backToLobby()">Back to Lobby</button>
    </div>
    <div id = "Lobby" style = "display:none">
        <h1>Word Search Game Lobby</h1>
        <table>
            <tr>
                <td><button onclick = "showPlayers()">Show Players</button>
                <td><button onclick = "showLeaderboard()">Show Leaderboard</button>
                <td><button onclick = "GlobalChat()">Global Chat</button>
            </tr>
            <tr>
                <td><button onclick = "game()">Join 2 Player Game</button>
            </tr>
        </table>
    </div>
    <div id="Players" style = "display:none">
        <h1>Players</h1>
            <button onclick = "showButPlay()">Show</button>
            <button onclick = "backToLobby()">Back to Lobby</button>
    </div>
    <div id="content" style = "display:none;">
        placeholder
    </div>
    <div id =  "Leaderboard" style = "display:none">
        <h1>Leaderboard</h1>
        <button onclick = "backToLobby()">Back to Lobby</button>
        <button onclick = "leaderboard()">Refresh</button>
    </div>
    <div id = "GlobalChat" style = "display:none">
        <h1>Global Chat</h1>
        <button onclick = "backToLobby()">Back to Lobby</button>
        <button onclick = "chat()">GoToChat</button>
    </div>
    <div class="chatting" style="display: none">
        <div class="chat-box" id="chatBox"></div>
        <form id="messageForm">
          <div class="input-box">
            <input type="text" id="messageInput" placeholder="Enter message here">
            <!-- <input type="submit" value="Send"> -->
            <button onclick="actuallyChatting()">Send</button>
            <button onclick = "backToLobby()">Back to Lobby</button>
          </div>
        </form>
    </div>

    <script>
        var serverUrl;
        serverUrl = "ws://" + window.location.hostname +":"+ (parseInt(location.port) + 100);
        connection = new WebSocket(serverUrl);
        idx = -1;
        var gameid = -1;
        function checkUsername(){
            var username = document.getElementById("username").value;
            if(username == ""){
                alert('Box cannot be left blank!');
                return; 
            }
            //length myust be less than 8
            if(username.length > 8){
                alert('Username must be less than 8 characters');
                return;
            }
            connection.send(JSON.stringify({name: username}));
            
            connection.onmessage = function(event) {
                var data = JSON.parse(event.data);
                if(data.type && data.type === "error") {
                    alert(data.msg); // Show the error message from the server
                    document.getElementById("getUsername").style.display = "block"; // Show the username input again
                    document.getElementById("Lobby").style.display = "none"; // Hide the lobby
                } else if(data.type && data.type === "success"){
                    document.getElementById("getUsername").style.display = "none";
                    document.getElementById("Lobby").style.display = "table";
                }
            };
        }

        function showPlayers(){
            document.getElementById("Lobby").style.display = "none";
            document.getElementById("Players").style.display = "table";
        }
        function showLeaderboard(){
            document.getElementById("Lobby").style.display = "none";
            document.getElementById("Leaderboard").style.display = "table";
        }
        function GlobalChat(){
            document.getElementById("Lobby").style.display = "none";
            document.getElementById("GlobalChat").style.display = "table";
        }
        function backToLobby(){
            document.getElementById("Players").style.display = "none";
            document.getElementById("content").style.display = "none";
            document.getElementById("Leaderboard").style.display = "none";
            document.getElementById("GlobalChat").style.display = "none";
            document.getElementsByClassName("chatting")[0].style.display = "none";
            document.getElementById("Game").style.display = "none";
            document.getElementById("Lobby").style.display = "table";
        }
        function showButPlay(){
            //add username to play
            let play = username.value + "<br>";
            for(let i = 0; i < 4; i++){
                play += "Player " + i + "<br>";
            }
            document.getElementById("content").innerHTML = play;
            document.getElementById("content").style.display = "table";
        }
        
        function leaderboard(){
            //add leaderboard
            let lead = "Leaderboard<br>";
            lead += username.value + "<br>";
            for(let i = 0; i < 4; i++){
                lead += "Player " + i + "<br>";
            }
            document.getElementById("content").innerHTML = lead;
            document.getElementById("content").style.display = "table";
        }
        function chat(){
            document.getElementById("GlobalChat").style.display = "none";
            document.getElementsByClassName("chatting")[0].style.display = "block";
        }

        const chatBox = document.getElementById("chatBox");
        const messageForm = document.getElementById("messageForm");
        const messageInput = document.getElementById("messageInput");
        messageForm.addEventListener("submit", actuallyChatting);
        function actuallyChatting(){
            event.preventDefault();
            const message = messageInput.value;
            // if(message === ""){
            //     alert('Message cannot be left blank!');
            //     return;
            // }
            messageInput.value = "";
            chatBox.innerHTML += username.value + ": " + message + "<br>";
        }

        function game(){
            document.getElementById("Lobby").style.display = "none";

            connection.send(JSON.stringify({action: "join2PlayerGame"}));
            
            connection.onmessage = function(event) {
                var wordGrid = JSON.parse(event.data);
                var gridHtml = "<table>";
                for(var i = 0; i < wordGrid.wordsGrid.length; i++){
                    gridHtml += "<tr>";
                    for(var j = 0; j < wordGrid.wordsGrid[i].length; j++){
                        gridHtml += `<td onmousedown="changeCellColor(this, true)" onmouseover="changeCellColor(this)" onmouseup="changeCellColor(this, false)" style="border: 1px solid black; padding: 2px; text-align: center; cursor: pointer; font-size: 10px;">${wordGrid.wordsGrid[i][j]}</td>`;
                    }
                    gridHtml += "</tr>";
                }
                gridHtml += "</table>";
                document.getElementById("wordGrid").innerHTML = gridHtml;
                document.getElementById("wordGrid").style.display = "block";

                document.addEventListener('mouseup', function() {
                    isMouseDown = false;
                });
            };
        }
        var isMouseDown = false;
        // Array to keep track of cells with changed color
        var changedCells = [];

        function changeCellColor(cell, mouseDownUp = null) {
            if (mouseDownUp === true) {
                isMouseDown = true; // Mouse is pressed down
                cell.style.backgroundColor = "red"; // Change color on mouse down
                // Add cell to changedCells array if not already included
                if (!changedCells.includes(cell)) {
                    changedCells.push(cell);
                }
            } else if (mouseDownUp === false) {
                isMouseDown = false; // Mouse is released
                // Reset the background color of all changed cells
                resetCellColors();
            } else if (isMouseDown) {
                cell.style.backgroundColor = "red"; // Change color on mouse over while mouse is down
                // Add cell to changedCells array if not already included
                if (!changedCells.includes(cell)) {
                    changedCells.push(cell);
                }
            }
        }

        // Function to reset the background color of all changed cells
        function resetCellColors() {
            changedCells.forEach(function(cell) {
                cell.style.backgroundColor = ""; // Reset color
            });
            // Clear the array after resetting colors
            changedCells = [];
        }

        // Ensure to call resetCellColors on global mouse up event
        document.addEventListener('mouseup', function() {
            isMouseDown = false;
            resetCellColors(); // Reset colors on mouse up anywhere in the document
        });
      </script>
</body>
</html>
